(function(a,b,c){b.extend(c,{myInit:function(){if(b("#roleList")[0]){if(b("#roleList").innerHeight()>=50){b("#role").css({height:"50px",overflow:"hidden"})}else{b("#role").css({height:"auto"})}}var f=c,g=b.getHashPara("pq"),e=b.getHashPara("tab"),k=b("#wantSeeBtn"),q=b("#mvTabs"),l=b("#commentTab"),m=b(".hallShow");if(g&&b("#pq")[0]){b(document).scrollTop(b("#pq").offset().top)}b("#share").hover(function(){b(this).find(".share_inner").addClass("on")},function(){b(this).find(".share_inner").removeClass("on")});Share.iconShare(b("#shareDiv").get(0));f.bindHotEvent();if(b.browser.msie&&b("#vtit")[0]){var n=b("#vtit").val();document.title=n;setInterval(function(){document.title=n},1000)}f.hollShowInit();q.bindTab("click");f.tabTop=q.offset().top;f.mvTab=q;b(a).scroll(f.setPosition);if(q.find("li").length>1){l.click(f.commentTabClick);if(e=="comment"){l.click()}}else{f.showCommentContent(b("#lCommentList").find(".detail"));f.bindCommentEv()}if(k.length){k.click(function(){f.wantToSee(b(this))});f.initEmlEvent()}if(b("#mvPlayer")[0]){var p=b("#mvPlayer").attr("purl");var d=b.getParaFromString(p,"coverpic");if(d){var i=new Image(),o,j;maxWidth=parseInt(b("#mvPlayer").css("width")),maxHeight=parseInt(b("#mvPlayer").css("height"));i.onload=function(){o=i.width,j=i.height;if(o>maxWidth){o=maxWidth;j=o*i.height/i.width}if(j>maxHeight){j=maxHeight;o=j*i.width/i.height}b("#mvPlayer #coverPic").attr("src",d).css({width:o+"px",height:j+"px"});i=null};i.src=d}b("#mvPlayer").click(function(){f.view(b.isIos?this.getAttribute("ipurl"):this.getAttribute("purl"))})}},setPosition:function(){var d=c,e=(document.documentElement.scrollTop||document.body.scrollTop);if(e>d.tabTop){d.mvTab.addClass("tab_fixed")}else{d.mvTab.removeClass("tab_fixed")}},hollShowInit:function(){b("body").delegate(".tryAgain","click",function(){var d=c,f=b(this).closest(".hallWrap"),g=f.attr("tId"),e=d.loadSecTimes;if(!e[g]||(!!e[g]&&e[g]<4)){d.loadSec(f,g)}else{f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}});b("body").delegate(".hallTip","mouseenter",function(){b(this).show()}).delegate(".hallTip","mouseleave",function(){b(this).hide()});b("body").delegate(".hallBar","mouseenter",function(){var d=c,f=b(this).closest(".hallWrap"),g=f.attr("tId"),e=d.loadSecTimes;if(!f.data("isLoad")){if(!e[g]||(!!e[g]&&e[g]<4)){d.loadSec(f,g)}else{f.find(".hallTip").show().html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}else{f.find(".hallTip").show()}}).delegate(".hallBar","mouseleave",function(){var d=c,e=b(this).closest(".hallWrap");e.find(".hallTip").hide()})},loadSecTimes:{},loadSec:function(f,h){var d=c,e=d.loadSecTimes,g=b();if(!e[h]){e[h]=0}f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false"><img src="'+c.cdnBaseUrl+'/images/detail/loading2.gif?v=20130629" width="20" height="20" alt="" /><div>加载中</div></div>').show();d.get("/order/seatPreview.html",{ticket_id:h},function(m,n){if(!m&&n){var r=f.find(".hallTip");r.html("<i></i>"+n);var l=f.find(".seat_box"),k=l.attr("seatLoad");if(k=="over"){f.data("isLoad",true);e[h]=3}else{if(k=="error"){f.data("isLoad",false);e[h]++;if(e[h]>3){r.html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}else{if(k=="success"){var s,q,o,j;f.data("isLoad",true);s=parseFloat(l.css("width"))+20;q=parseFloat(l.css("height"))+20;o=parseFloat(s-70)/2*(-1);j=parseFloat(q)*(-1);r.css({width:s+"px",height:q+"px","margin-left":o+"px","margin-top":j+"px"})}}}}else{f.data("isLoad",false);var p=e[h];if(p<4){f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="error">加载失败，<a href="javascript:;"  class="tryAgain imp">再试一次</a></div>');e[h]=++p}else{f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}})},bindHotEvent:function(){var e=c,f=b("#part2");var d=b("#timeTabs").find(">.active >.low");if(d.length){b("#district_areaList").find("li:last-child").removeClass("hide")}b(document).click(function(i){var h=i.target||i.srcElement,j=b(h).closest("#all_type_box"),g=b(h).closest(".sel_cinema_left");if(j.length<=0&&g.length<=0){b("#all_type_box").addClass("hide");b("#all_cinema").find(".sel_cinema_left > i").removeClass("triangleToUp")}});f.delegate("#timeTabs","click",e.timeTabsClick).delegate("#district_areaList","click",function(n){var j=c,m=n.target||n.srcElement,g=b(m).closest("li"),h=b(m).closest(".sel_cinema"),l=b(m).closest(".notesTip");if(g.length&&((g.hasClass("all_cinema")&&h.length)||!g.hasClass("all_cinema"))){if(g.attr("cType")&&g.attr("cType")=="ALL"){try{movieAllClick="http://piao.163.com/movieall.html";neteaseTracker(true,movieAllClick,"全部影院",null)}catch(n){}}if(g.attr("cType")&&g.attr("cType")=="Offen"){try{offenClick="http://piao.163.com/movieofen.html";neteaseTracker(true,offenClick,"常去影院",null)}catch(n){}}if(g.attr("cType")&&g.attr("cType")=="LowPrice"){try{lowpriceClick="http://piao.163.com/moviecheap.html";neteaseTracker(true,lowpriceClick,"低价影院",null)}catch(n){}}g.addClass("active").siblings().removeClass("active");b("#cinema_search").addClass("textGray").val("快速搜索影院");j.by="district";j.getPost()}else{if(l.length){var k=b(m).closest(".close");if(k.length){b.cookie("notesTipShow","1",{expires:365,path:"/",domain:"piao.163.com"});l.remove();return false}}}}).delegate("#all_cinema > .sel_cinema_left","click",function(j){var h=b(this).find("i"),g=b("#all_type_box");if(g.hasClass("hide")){h.addClass("triangleToUp");g.removeClass("hide")}else{h.removeClass("triangleToUp");g.addClass("hide")}return false}).delegate("#all_type_box","click",function(j){var h=c,i=j.srcElement||j.target,g=b(i).closest("a");if(!g.length){return}b("#all_cinema").find(".sel_cinema_left > i").removeClass("triangleToUp");b(this).addClass("hide");b(this).find("a").removeClass("active");if(!g.hasClass("close")){var k=b("#all_cinema");k.attr("cType",g.closest(".type_module").attr("cType"));k.attr("typeId",g.attr("typeId"));k.addClass("active").siblings().removeClass("active");k.find(".sel_cinema > span").text(g.find("span").text());g.addClass("active");b("#cinema_search").addClass("textGray").val("快速搜索影院");h.by="district";h.getPost()}return false}).delegate("#cinema_search","click",function(h){var g=c;b(this).removeClass("textGray");if(this.value=="快速搜索影院"){this.value=""}if(!g.cacheOfSearchCinemaList){g.toSearchCinema(1)}else{g.filterSearchCinema(this,true)}}).delegate("#cinema_search","blur",function(g){if(this.value==""){this.value="快速搜索影院";b(this).addClass("textGray")}}).delegate("#cinema_search","keyup",function(k){var h=c,i=b("#cinema_search"),j=b("#cinema_search_list"),g=j.find(".on");switch(k.keyCode){case 38:if(!j.hasClass("hide")){if(g.length&&g.prev().length){g.removeClass("on");g=g.prev().addClass("on");i.val(g.text())}}break;case 40:if(!j.hasClass("hide")){if(g.length){if(g.next().length){g.removeClass("on");g=g.next().addClass("on")}}else{g=j.find("a").first().addClass("on")}i.val(g.text())}break;case 13:try{buyKeyCode="http://piao.163.com/"+c.curCity.spell+"/movie/"+c.movieId+".html#from=movie.enter";neteaseTracker(true,buyKeyCode,"影院搜索",null)}catch(k){}if(!j.hasClass("hide")&&g.length){this.value=g.text()}b("#cinema_search_list").addClass("hide");h.showFilterResult(this.value);break;default:h.filterSearchCinema(this,true);break}}).delegate("#cinema_search_btn","click",function(h){var g=c;try{buyClick="http://piao.163.com/"+c.curCity.spell+"/movie/"+c.movieId+".html#from=movie.enter";neteaseTracker(true,buyClick,"影院搜索",null)}catch(h){}if(!g.cacheOfSearchCinemaList){g.toSearchCinema(2)}else{g.showFilterResult(b("#cinema_search").val())}}).delegate("#cinema_search_list","mouseenter",function(g){b(this).removeClass("hide")}).delegate("#cinema_search_list","mouseleave",function(g){b(this).addClass("hide")}).delegate("#cinema_search_list","click",function(k){var i=c,j=k.srcElement||k.target,h=b(j).closest("a");if(h.length){b("#cinema_search").val(h.text());b("#district_areaList").find("li").removeClass("active");b("#areaContent").find(".mv_cinema_rs>.arrow").get(0).className="arrow arrow4";var g=b(b.format('<li cid="{id}"  isSeatSupportNow="{isSeatSupportNow}" class="active"><a href="javascript:;"><i class="sub"></i>{name}</a></li>',{name:h.text(),id:h.attr("cid"),isSeatSupportNow:h.attr("isSeatSupportNow")}));b("#cinamaList").parent().attr("style","");b("#cinamaList").css("margin-top","0").html(g);b("#cinema_page").html("");b(this).addClass("hide");i.by="cinema";i.getPost({cinemaId:h.attr("cid"),cinemaType:"ALL"})}}).delegate("#cinema_search_list > a","mouseenter",function(g){b(this).addClass("on")}).delegate("#cinema_search_list > a","mouseleave",function(g){b(this).removeClass("on")}).delegate("#cinamaList","click",e.cinemaListClick).delegate("#cinema_page","click",function(n){var m=n.srcElement||n.target,i=b(m).closest("a");if(i.length){var l=b("#cinamaList"),k=b(this).find("span"),h=k.text().split("/"),g=+h[0],j=+h[1];if(i.hasClass("page_left")){if(g<=1){return}g--;if(g==1){i.addClass("page_left_end")}i.next().removeClass("page_right_end")}else{if(g>=j){return}g++;if(g==j){i.addClass("page_right_end")}i.prev().removeClass("page_left_end")}k.text(g+"/"+j);l.fadeOut("fast",function(){l.css("margin-top",-((g-1)*105)+"px");l.fadeIn("fast")})}}).delegate("#mvSubTabs","click",function(h){var g=c;g.by="ticket";g.subTabClick(h)}).delegate("#dmspan","click",e.dmFilterClick);b(document).click(function(h){var g=h.target||h.srcElement;if(b(g).attr("id")!="cinema_search"&&b(g).attr("id")!="cinema_search_list"){b("#cinema_search_list").addClass("hide")}});e.overTable()},timeTabsClick:function(l){var g=c,k=l.target||l.srcElement,d=b(k).closest("li"),f=b(k).closest("a");if(d.length){d.siblings(".active").removeClass("active");d.addClass("active");g.cacheOfSearchCinemaList=null;g.by="date";g.getPost()}else{if(f.length){var j=b(this),h=f.find("i");if(h.hasClass("triangleToUp")){j.css({height:"30px"});h.removeClass("triangleToUp")}else{j.css({height:"auto"});h.addClass("triangleToUp")}}}},cinemaListClick:function(i){var f=c,h=i.target||i.srcElement,d=b(h).closest("li"),g=b(h).closest(".refresh");if(d.length){d.siblings(".active").removeClass("active");d.addClass("active");f.by="cinema";f.getPost()}else{if(g.length){a.location.reload()}}},cacheOfSearchCinemaList:null,toSearchCinema:function(e){var d=c;d.post("/movie/cinema_tip.html",{city:d.curCity.id,movieId:d.movieId,date:b(".active","#timeTabs").attr("day")},function(g,f){if(!g){f=d.parseJSON(f);d.cacheOfSearchCinemaList=f.list;if(e==1){d.filterSearchCinema(b("#cinema_search").get(0),true)}else{d.filterSearchCinema(b("#cinema_search").get(0));d.showFilterResult(b("#cinema_search").val())}}})},filterSearchCinema:function(r,j){var h=c,m=h.cacheOfSearchCinemaList,t=r.value,e=r.value.toLowerCase(),d=document.createDocumentFragment(),s=b("#cinema_search_list"),f=new RegExp("^(.*)("+b.safeRegStr(t)+")(.*)$","i"),p=0;if(!m||!t){s.html("").addClass("hide");return}var l=m.length,u,o=false;for(var k=0,g=0;k<l;k++){if(g>=9){break}u=m[k];if(u.name.toLowerCase().indexOf(e)>=0){g++;o=true;var q=b(b.format('<a cid={id} href="javascript:;" isSeatSupportNow="{isSeatSupportNow}">{name}</a>',{name:u.name.replace(f,"$1<em>$2</em>$3"),id:u.id,isSeatSupportNow:u.isSeatSupportNow}));d.appendChild(q.get(0))}p=g}if(p<9){for(var k=0,g=0;k<l;k++){if(p+g>=9){break}u=m[k];if(u.name.toLowerCase().indexOf(e)<0&&u.spell.toLowerCase().indexOf(e)>=0){g++;o=true;var q=b(b.format('<a cid={id} href="javascript:;" isSeatSupportNow="{isSeatSupportNow}">{name}</a>',{name:u.name.replace(f,"$1<em>$2</em>$3"),id:u.id,isSeatSupportNow:u.isSeatSupportNow}));d.appendChild(q.get(0))}}}s.html("").addClass("hide");if(o){s.html(d);if(j){s.removeClass("hide")}}},showFilterResult:function(o){var g=c,k=g.cacheOfSearchCinemaList,d=document.createDocumentFragment(),e=0,m=b("#cinema_search_list"),q=b("#cinamaList");if(!k||!o){return}b("#district_areaList").find("li").removeClass("active");b("#areaContent").find(".mv_cinema_rs>.arrow").get(0).className="arrow arrow4";if(m.find("a").length<=0){q.parent().attr("style","");q.css("margin-top","0").html('<div id="noWaiting" class="noWaiting noTop"><b></b>暂无相关影院，<a href="javascript:;">查看全部影院</a></div>');b("#cinema_page").remove();b("#cinemaContent").addClass("hide").html("");q.find("a").bind("click",function(){g.by="district";g.getPost({cinemaType:"ALL"})});return}var j=k.length,p;for(var h=0;h<j;h++){p=k[h];if(p.name.indexOf(o)>=0||p.spell.indexOf(o)>=0){var l=b(b.format('<li cid="{id}" isSeatSupportNow="{isSeatSupportNow}"><a href="javascript:;"><i class="sub"></i>{name}</a></li>',{name:p.name,id:p.id,isSeatSupportNow:p.isSeatSupportNow}));d.appendChild(l.get(0));e++}}if(e>0){q.parent().attr("style","");q.css("margin-top","0").html(d).find("li:first-child").addClass("active");b("#cinema_page").remove();var f=Math.ceil(e/9);if(f>1){q.parent().css({overflow:"hidden",height:"110px",position:"relative"}).after('<div id="cinema_page" class="cinema_page"><span>1/'+f+'</span><a class="page_left page_left_end"></a><a class="page_right"></a></div>')}g.by="cinema";g.getPost({cinemaType:"ALL"})}},by:"",postData:{city:c.curCity.id,date:"",movieId:c.movieId,cinemaId:"",cinemaType:"",typeId:""},resetPostData:function(e){var d=c;b.extend(d.postData,{date:b(".active","#timeTabs").attr("day"),cinemaId:b(".active","#cinamaList").attr("cid"),cinemaType:b("#district_areaList").find(">.active").attr("cType"),typeId:b("#district_areaList").find(">.active").attr("typeId")});if(!!e){b.extend(d.postData,e)}},getPost:function(h){var e=c,g,d,f="/movie/schedule1.html";e.resetPostData(h);switch(e.by){case"date":g=b("#dateContent");f="/movie/schedule2.html";d=e.loadingPanel({renderTo:b("#part2"),height:g.outerHeight(),style:{top:"auto",bottom:"0"}});break;case"district":g=b("#areaContent");f="/movie/schedule3.html";d=e.loadingPanel({renderTo:g,height:g.outerHeight()});break;case"cinema":g=b("#cinemaContent");f="/movie/schedule4.html";e.postData.isSeatSupportNow=b(".active","#cinamaList").attr("isSeatSupportNow");d=e.loadingPanel({renderTo:g,height:g.outerHeight()});break;case"ticket":g=b("#cinemaContent");f="/movie/schedule4.html";e.postData.ticketType=b(".active","#mvSubTabs").attr("rel")=="#subPart2"?1:0;break}e.post(e.scheduleUrl||f,e.postData,function(n,l){!!d&&d.clear();b("#part2").attr("style","");if(!n&&l){if(g&&g.length){g.replaceWith(l);if(e.by=="date"){var k=b("#timeTabs").find(">.active >.low");if(k.length){b("#district_areaList").find("li:last-child").removeClass("hide")}}else{if(e.by=="district"){g=b("#areaContent");var m=e.postData.cinemaType,j=b("#district_areaList").find("li").length;if(m=="Offen"){g.find(".mv_cinema_rs>.arrow").get(0).className="arrow arrow2"}else{if(m=="LowPrice"){if(j==2){g.find(".mv_cinema_rs>.arrow").get(0).className="arrow arrow2"}else{g.find(".mv_cinema_rs>.arrow").get(0).className="arrow arrow3"}}else{g.find(".mv_cinema_rs>.arrow").get(0).className="arrow";if(m=="ALL"){var o=b("#all_cinema"),i=b("#all_type_box");o.addClass("active").attr("typeId","1").attr("cType","ALL");o.find(".sel_cinema > span").text("全部影院");i.find("a").removeClass("active");i.find(".all").addClass("active");b("#cinema_search").addClass("textGray").val("快速搜索影院")}}}}}e.postData.ticketType="";e.postData.isSeatSupportNow=""}}},"@getList")},bindPhotoEv:function(){var d=this;var e=b.imgSlide({moveSize:4,duration:600,leftButton:"leftPBtn",rightButton:"rightPBtn",listId:"sphotoList"});b("#sphotoList").find("li").each(function(f,g){b(g).click(function(){b(this).siblings(".active").removeClass("active");b(this).addClass("active");d.showBigMvpic(d.bigPhotoUrls,f)})})},showCommentContent:function(d){d.each(function(){var f=this,e=b(this).closest("li");if(f.scrollHeight<=f.clientHeight){e.find(".btn_all").html("")}else{e.find(".detailDot").show()}})},commentTabClick:function(){var d=c,e=b(this);if(!e.data("isLoad")&&d.movieId){d.post("/movie/comment_list.html",{movieId:d.movieId},function(g,f){if(!g&&f){b("#part1").html(f);e.data("isLoad",true);d.showCommentContent(b("#lCommentList").find(".detail"));d.bindCommentEv()}})}},bindCommentEv:function(){var d=c,e=b("#shortTxtArea");b("#writeScommt").click(d.writeSCmtEvent);b("body").delegate(".btn_all a","click",d.moreInfoEv);if(b("#sphotoList")[0]){d.bindPhotoEv()}d.getCommt();b("#moreScommt").click(function(){d.getCommt()});d.imgObj={};d.showBigPoster()},moreInfoEv:function(){var g=b(this),f=g.parent().siblings(".detail").find("span[spec=1]"),d=g.closest("li"),e=d.find(".detailDot");if(g.hasClass("up")){d.removeClass("active");e.show();g.removeClass("up").text("[查看全文]")}else{d.addClass("active");e.hide();g.addClass("up").text("[收起]")}},template:function(d,i,h){var g=h||"%",e=new Function("var p=[],me=this,data=me,print=function(){p.push.apply(p,arguments);};p.push('"+d.replace(/[\r\t\n]/g," ").replace(new RegExp("<"+g+"=\\s*([^\\t]*?);*\\s*"+g+">","g"),"<"+g+"print($1);"+g+">").split("<"+g).join("\t").replace(new RegExp("((^|"+g+">)[^\\t]*)'","g"),"$1\r").replace(new RegExp("\\t=(.*?)"+g+">","g"),"',$1,'").split("\t").join("');").split(g+">").join("p.push('").split("\r").join("\\'")+"');return p.join('');");return i?e.call(i):e},getCommt:function(){var d=c,i=b("#sCommentList"),g=b("#noShortPart"),e=b("#tmpGetPosts").html();if(i.find("dd").length>0){var f=i.find("dd:last-child").attr("sId")}var h={req_id:d.movieId,req_type:"movie",sort:"time",count:20,maxId:!!f?f:0};b.ajax({dataType:"jsonp",url:"http://qz.dianying.163.com/w/req_getPosts",data:h,success:function(n){var m=b("#moreScommt"),l=b("#commCount_S");n=typeof n=="object"?n:d.parseJSON(n);if(+n.result===100){if(!f&&(!n.posts||n.posts.length===0)){g.show();return}if(!n.posts||n.posts.length===0){if(!f){g.show()}else{m.addClass("hide");i.find("dd:last-child").addClass("last")}return}if(!!n.posts&&n.posts.length>0){for(var q=0;q<n.posts.length;q++){var p=[];var k=[];if(!!n.posts[q].imageList&&n.posts[q].imageList.length>0){for(var o=0;o<n.posts[q].imageList.length;o++){p.push(n.posts[q].imageList[o].thumbnailUrl);k.push(n.posts[q].imageList[o].originalUrl)}}d.imgObj["imgS"+n.posts[q].id]=p;d.imgObj["imgB"+n.posts[q].id]=k;n.posts[q].createTime=c.formatCreatTime(n.posts[q].createTime)}}i.find("dd:last-child").removeClass("last");i.append(d.template(e,n.posts));i.find("dd:last-child").addClass("last");l.find("em").text(n.board.mainPostsNum);if(!n.moreFlag||n.moreFlag!==1){m.addClass("hide")}else{m.removeClass("hide")}}else{if(!f){g.show()}else{m.addClass("hide");i.find("dd:last-child").addClass("last")}}},error:function(){if(!f){g.show()}else{moreScommt.addClass("hide");i.find("dd:last-child").addClass("last")}}})},formatCreatTime:function(d){var f="",e="";e=d.substring(0,10);f=parseInt(((new Date(c.nowTime))-new Date(d.replace(/-/g,"/")))/1000);f=f<=0?1:f;if(f<=60){f=Math.ceil(f)+"秒之前"}else{if(f<=3600){f=Math.ceil(f/60)+"分钟之前"}else{if(f<=86400){f=Math.ceil(f/60/60)+"小时之前"}else{f=e}}}return f},showBigPoster:function(){var f=b("#sCommentList"),d=c,e=b("#tmpBigPosts").html();f.delegate(".comment-pic-small li","click",function(){var k=b(this).parent(),g=k.parent().attr("sid"),j=b(this).index(),i=k.parent().find(".detail");k.hide().after(d.template(e,d.imgObj["imgS"+g]));i.css("color","#333");var h={obj:k,cInd:j,imgSrcObj:d.imgObj["imgB"+g]};setTimeout(function(){b.imgZoom(h)},100)})}})})(window,jQuery,Core);
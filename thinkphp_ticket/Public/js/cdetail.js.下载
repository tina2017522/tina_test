(function(a,b,c){b.extend(c,{myInit:function(){var d=this;var f=b.getHashPara("pq");if(f&&b("#pq")[0]){b(document).scrollTop(b("#pq").offset().top)}b("#collect_cinema").click(function(){d.doCollect(this)});b("#feedback_cinema").click(function(){d.doFeedback()});b(".commentSub").click(function(i){var h=i.target||i.srcElement,g=b(h).closest("a");if(g.length){e.find("li").last().addClass("active").siblings().removeClass("active");b("#subPart2").css({display:"block"});b("#subPart1").css({display:"none"})}});b(".seatSub").click(function(i){var h=i.target||i.srcElement,g=b(h).closest("a");if(g.length){e.find("li").eq(0).addClass("active").siblings().removeClass("active");b("#subPart2").css({display:"none"});b("#subPart1").css({display:"block"})}});d.showAboutCinema();d.showSmallMap();d.initGroupCoupon();var e=b("#mvTabs");e.find("li").click(d.subTabClick);d.tabTop=e.offset().top;d.mvTab=e;b(a).scroll(d.setPosition);d.bindEvent();b("body").delegate("#photo_list_recent","click",function(i){var h=i.target||i.srcElement,g=b(h).closest("li");if(g.length){g.addClass("active").siblings().removeClass("active");b(".recentMovie").find("dl").eq(g.index()).removeClass("hide").siblings("dl").addClass("hide")}})},showAboutCinema:function(){var e=b(".relCinemaBox"),i=b(".relCinema"),f=e.height(),h=i.height(),d=b(".relTitle").find(".relCinemaBar"),g=d.attr("data-show");if(h>f){d.removeClass("hide")}d.click(function(){if(!g){g=1;b(this).html("展开>>");e.removeClass("relCinemaShow")}else{g=0;b(this).html("收起>>");e.addClass("relCinemaShow")}})},doCollect:function(f){var d=c,e=b(f);if(!d.easyNav.isLogin(true)){d.login();return}if(e.hasClass("collected")){d.post("/cinema/cellectCancel.html",{cinema_id:e.parent().attr("cid")},function(h,g){if(!h){g=d.parseJSON(g);if(+g.retcode==200){e.text("收藏").removeClass("collected")}else{if(+g.retcode==464){if(!d.easyNav.isLogin(true)){d.login();return}}else{alert("系统异常，请重试！")}}}})}else{d.post("/cinema/cellect.html",{cinema_id:e.parent().attr("cid"),city:d.curCity.id},function(h,g){if(!h){g=d.parseJSON(g);if(+g.retcode==200){e.text("已收藏").addClass("collected")}else{if(+g.retcode==464){if(!d.easyNav.isLogin(true)){d.login();return}}else{alert("系统异常，请重试！")}}}})}},doFeedback:function(){var d=b(['<div class="commDialog feedbackDialog">','<a href="javascript:;" class="close"></a>','<p id="typeTab" class="dialogTitle">影院信息纠错</p>','<div class="feedback">','<p class="title">',b(".cinemaInfo").find(".mv_name").attr("title"),"</p>",'<ul class="feedbackLevel clearfix"><li><input id="c5" type="checkbox" value="5" name="checklevel"><label for="r5" class="levelFace"><span>名称错误</span></label></li><li><input id="c4" type="checkbox" value="4" name="checklevel"><label for="r4" class="levelFace"><span>地址错误</span></label></li><li><input id="c3" type="checkbox" value="3" name="checklevel"><label for="r3" class="levelFace"><span>电话错误</span></label></li><li><input id="c2" type="checkbox" value="2" name="checklevel"><label for="r2" class="levelFace"><span>优惠错误</span></label></li><li class="last"><input id="c1" type="checkbox" value="1" name="checklevel"><label for="r1" class="levelFace"><span>其他错误</span></label></li></ul>','<textarea class="comm_area textGray" rows="" cols="" name="message">帮助我们提供一下正确信息吧~</textarea>','<div class="note"><a rel="1" class="sub" href="javascript:;">提交</a><span class="err hide2">请输入错误信息内容！</span></div></div>',"</div>"].join(""));b.dialog();b.dialog({title:"",content:d.get(0),width:0,animate:0,button:[],init:function(){b(".iDialogClose").remove();var e=c,f=b(".commDialog",this);f.find(">.close").click(function(){b.dialog()});f.find(".comm_area").focus(function(){if(this.value=="帮助我们提供一下正确信息吧~"){this.value=""}b(this).removeClass("textGray")}).blur(function(){if(!this.value){this.value="帮助我们提供一下正确信息吧~";b(this).addClass("textGray")}});f.find(".sub").click(function(){var h=c,i=f.find(".title").text(),g="",k=f.find(".comm_area").val(),j=f.find(".err");if(!k||k=="帮助我们提供一下正确信息吧~"){j.removeClass("hide2");return false}j.addClass("hide2");f.find(":checkbox").each(function(m,l){if(this.checked){g+=";"+b(this).next().text()}});if(!!g){g=g.substr(1)}b.dialog();h.post("/cinema/submitCinemaCorrect.html",{content:k,name:i,quesType:g},function(m,l){if(!m){l=h.parseJSON(l);if(+l.retcode==200){h.showDialogFunc({content:'<div class="commDialog_result feedbackDialog_result"><a class="closeBtn closePop" href="javascript:;"></a><b></b><h3>感谢您提供的信息！</h3><a href="javascript:;" class="btn closePop">确认</a></div>',width:"",init:function(){b(".iDialogClose").remove();b(".closePop,this").click(function(){b.dialog()})}})}else{b.dialog()}}})})}})},setPosition:function(){var d=c,e=(document.documentElement.scrollTop||document.body.scrollTop);if(e>d.tabTop){d.mvTab.addClass("tab_fixed")}else{d.mvTab.removeClass("tab_fixed")}},initGroupCoupon:function(){var f=b(".groupCoupon"),d=f.find(".boxs"),g=f.find(".moreBtn"),e=f.find(".couponHelp");if(g.length){g.click(function(){var h=b(this).parent();if(h.hasClass("groupCoupon_showMore")){b(this).html("更多&nbsp;&nbsp;&nbsp;&nbsp;<i></i>");h.removeClass("groupCoupon_showMore");d.height(82)}else{b(this).html("收起&nbsp;&nbsp;&nbsp;&nbsp;<i></i>");h.addClass("groupCoupon_showMore");d.find(".box").removeClass("hide");d.height(82*(Math.ceil(parseInt(h.attr("t"))/2))+2)}})}if(e.length){e.hover(function(n){var o=n.target||n.srcElement,p=b(this).attr("partnerId")||0,h=b(this).attr("cid")||0,q=f.find(".couponIntro"),l=b(o).closest(".box"),m=l.index(),k=0,j=b(this).position().left+71;if(m%2==1){k=212;j+=373}if(b(".box").length==1){if(b(this).position().left>272){k=212}j=b(this).position().left+71}var i=b(".boxWrap").offset().top+b(".boxWrap").height()-b(this).offset().top;q.css({bottom:(i+10)+"px",left:k+"px"}).removeClass("hide").find("i").css({left:(j-k)+"px"});n.stopPropagation()},function(i){var h=i.target||i.srcElement;f.find(".couponIntro").addClass("hide");i.stopPropagation()})}},bindEvent:function(){b("body").delegate(".movieTbodyAct tr","mouseenter",function(){b(this).addClass("active")}).delegate(".movieTbodyAct tr","mouseleave",function(){b(this).removeClass("active")});b("#mainContent").delegate(".dataList","click",this.filterData).delegate("#dmspan","click",this.dmFilterClick).delegate(".btn_pre","click",function(){c.view(this.getAttribute("pvurl"))}).delegate(".moreDate","click",function(){if(b(this).hasClass("moreDate")){var d=b(this).parent();if(b(this).hasClass("on")){d.css({height:"34px"});b(this).removeClass("on").find("i").removeClass("triangleToUp")}else{var e=d.find("li").length,f=Math.ceil(e/4);d.css({height:f*34+"px"});b(this).addClass("on").find("i").addClass("triangleToUp")}return false}});b("body").delegate(".tryAgain","click",function(){var d=c,f=b(this).closest(".hallWrap"),g=f.attr("tId"),e=d.loadSecTimes;if(!e[g]||(!!e[g]&&e[g]<4)){d.loadSec(f,g)}else{f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}});b("body").delegate(".hallTip","mouseenter",function(){b(this).show()}).delegate(".hallTip","mouseleave",function(){b(this).hide()});b("body").delegate(".hallBar","mouseenter",function(){var d=c,f=b(this).closest(".hallWrap"),g=f.attr("tId"),e=d.loadSecTimes;if(!f.data("isLoad")){if(!e[g]||(!!e[g]&&e[g]<4)){d.loadSec(f,g)}else{f.find(".hallTip").show().html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}else{f.find(".hallTip").show()}}).delegate(".hallBar","mouseleave",function(){var d=c,e=b(this).closest(".hallWrap");e.find(".hallTip").hide()})},filterData:function(k){var g=c,f=g.postData,j=b(k.target),d=j.closest("li"),h=j.attr("pid"),l=d.closest("ul").attr("id"),i=d.closest("ul").attr("t");!!d.length&&d.find("a").blur();if(!d.length||d.hasClass("active")||!l){return}d.siblings(".active").removeClass("active");d.addClass("active");l=l.trim();if(l=="timeTabs"){f.by="date";if(i){g.getFilms(d.attr("day"));return}}else{if(l=="photo_list"){f.by="movie"}}g.resetPostData();if(l=="rightTab"){f.by="movie";f.target="rightTab";g.postData.movieId=d.find("a").attr("pid")}if(!f.by){return}g.getPost();k.stopPropagation()},resetPostData:function(){b.extend(this.postData,{date:b(".active","#timeTabs").attr("day"),movieId:b(".active","#photo_list").find("a").attr("pid")})},getPost:function(){var e=c,g,d,f="/cinema/schedule.html";switch(e.postData.by){case"tab":g=b("#today");break;case"date":g=b("#dateContent");d=e.loadingPanel({renderTo:g});break;case"movie":g=b("#movieContent");if(this.postData.target=="rightTab"){this.postData.target="";d=e.loadingPanel({renderTo:b("#dateContent")})}else{d=e.loadingPanel({renderTo:g})}break}e.post(f,this.postData,function(k,i){!!d&&d.clear();if(!k&&i){var h=e.postData,j=h.by;if(j=="movie"){if(b("#rightTab").find("li:last").hasClass("active")){b(".c_detail_poster").fadeOut("fast")}g.length&&g.fadeOut("fast",function(){g.replaceWith(i);b("#movieContent").fadeIn("slow");var m=b(".c_detail_poster"),n=b("#photo_list"),l=n.find("li").length;if(b("#rightTab").find("li:first").hasClass("active")&&m.css("display")=="none"){m.addClass("noLeft").removeClass("noRight");n.find("li").removeClass("active").first().addClass("active");n.css({left:0}).attr("curPage","1");if(l<=6){m.addClass("noRight")}m.fadeIn("slow")}})}else{g.length&&g.replaceWith(i)}}},"@getList")},getFilms:function(e){var d=this;d.post("/cinema/schedule2.html",{city:d.postData.city,cinemaId:d.postData.cinemaId,date:e},function(g,f){if(!g&&f){b("#filmInfos").replaceWith(f)}})},subTabClick:function(k){var j=b(k.target).closest("li"),h=c,l=b("#movieInfo"),f=j.attr("rel"),g=h.postData,i,d;if(!j[0]||j.hasClass("active")){return}j.siblings().removeClass("active");j.addClass("active");if(f=="#subPart1"){i="http://piao.163.com/cinema/"+g.cinemaId+".html?buyseat";neteaseTracker(true,i,"在线选座",null);b("#subPart2").hide()}else{d="http://piao.163.com/cinema/"+g.cinemaId+".html?buycoupon";neteaseTracker(true,d,"兑换券",null);b("#subPart1").hide()}b(f).show();a.setTimeout(function(){h.setPosition()},10)},showSmallMap:function(){var f=c,g=new BMap.Map("mapDiv",{enableDragging:false,defaultCursor:"pointer"}),d=new BMap.Point(parseFloat(f.coord.split(",")[0]),parseFloat(f.coord.split(",")[1]));g.centerAndZoom(d,15);g.disableDoubleClickZoom();var e=new BMap.Marker(d);g.addEventListener("click",function(h){});g.addOverlay(e);b(".seeBig").click(function(){c.cinemaMapDialog(f.postData.cinemaId)})},loadSecTimes:{},loadSec:function(f,g){var d=c,e=d.loadSecTimes;if(!e[g]){e[g]=0}f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false"><img src="'+c.cdnBaseUrl+'/images/detail/loading2.gif?v=20130629" width="20" height="20" alt="" /><div>加载中</div></div>').show();d.get("/order/seatPreview.html",{ticket_id:g},function(m,n){if(!m&&n){var r=f.find(".hallTip");r.html("<i></i>"+n);var l=f.find(".seat_box"),k=l.attr("seatLoad");if(k=="over"){f.data("isLoad",true);e[g]=3}else{if(k=="error"){f.data("isLoad",false);e[g]++;if(e[g]>3){r.html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}else{if(k=="success"){var s,q,o,j;f.data("isLoad",true);s=parseFloat(l.css("width"))+20;q=parseFloat(l.css("height"))+20;o=parseFloat(s-66)/2*(-1);j=parseFloat(q)*(-1);r.css({width:s+"px",height:q+"px","margin-left":o+"px","margin-top":j+"px"})}}}}else{f.data("isLoad",false);var p=e[g];if(p<4){f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="error">加载失败，<a href="javascript:;"  class="tryAgain imp">再试一次</a></div>');e[g]=++p}else{f.find(".hallTip").html('<i></i><div class="load_text seat_box" seatLoad="false">还是加载失败<br />看看其他时间吧</div>')}}})}})})(window,jQuery,Core);